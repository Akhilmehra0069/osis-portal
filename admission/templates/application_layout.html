{% extends "admission_layout.html" %}
{% load staticfiles %}
{% load i18n %}

{% comment "License" %}
* OSIS stands for Open Student Information System. It's an application
* designed to manage the core business of higher education institutions,
* such as universities, faculties, institutes and professional schools.
* The core business involves the administration of students, teachers,
* courses, programs and so on.
*
* Copyright (C) 2015-2016 Université catholique de Louvain (http://www.uclouvain.be)
*
* This program is free software: you can redistribute it and/or modify
* it under the terms of the GNU General Public License as published by
* the Free Software Foundation, either version 3 of the License, or
* (at your option) any later version.
*
* This program is distributed in the hope that it will be useful,
* but WITHOUT ANY WARRANTY; without even the implied warranty of
* MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
* GNU General Public License for more details.
*
* A copy of this license - GNU General Public License - is available
* at the root of the source code of this program.  If not,
* see http://www.gnu.org/licenses/.
{% endcomment %}
{% block style %}
<link rel="stylesheet" href="{% static 'css/bootstrap-datepicker3.min.css' %}" type='text/css'>
{% endblock %}
{% block content %}
    <h2>{{ request.user.first_name }} {{ request.user.last_name }}</h2>
    <span>
        La procédure de demande d'inscription en ligne est divisée en plusieurs onglets. La demande d'inscription ne
        pourra être validée que lorsque tous les onglets auront valablement été complétés. Les couleurs
        <span class="validated">verte </span>
        ou <span class="not-validated">orange</span>
        vous rappellent l'état d'avancement de votre demande d'inscription que vous pouvez d'ailleurs arrêter et
        reprendre à tout moment.
    </span>
    <br>

    <br>
    <input type="hidden" id="hdn_tab_active" value="{{tab_active}}" title="active tab">

    <input type="hidden" value="{{application.id | default_if_none:''}}" id="hdn_current_application_id" name="application_id" title="application_id" >
    <div class="row">
        <div class="col-md-2">
            {% if applications%}<a href="{%url 'home'%}">{% trans 'back_demandes_list'%}</a>{%endif%}
            <br>
            <br>
            <ul class="nav nav-pills nav-stacked">
                <li class="{%if tab_active == 0 %}active{%endif%}">
                    <a href="{%if application.id%}{% url 'profile' application.id%}{%else%}{% url 'profile' %}{%endif%}"
                       id="lnk_profile_tab">
                        {% if validated_profil %}
                            <span class="glyphicon glyphicon-ok-sign" aria-hidden="true" style="color:green;"></span>
                        {%else%}
                            <span class="glyphicon glyphicon-exclamation-sign" aria-hidden="true" style="color:orange;"></span>
                        {%endif%}
                        &nbsp;&nbsp;{%trans 'profile'%}</a>
                </li>
                <li class="{%if tab_active == 1 %}active{%endif%}">
                    {%if tab_applications%}
                        <a href="{%if application.id%}{% url 'applications' application.id%}{%else%}{% url 'applications' %}{%endif%}"
                           id="lnk_application_tab">
                            {% if validated_application %}
                            <span class="glyphicon glyphicon-ok-sign" aria-hidden="true" style="color:green;"></span>
                            {%else%}
                                <span class="glyphicon glyphicon-exclamation-sign" aria-hidden="true" style="color:orange;"></span>
                            {%endif%}
                            &nbsp;&nbsp;{%trans 'offer_choice'%}                     {%if application.offer_year %}
                    ({{application.offer_year.acronym}})
                    {%endif%}</a>
                    {%else%}
                        <a class="not-active"
                           id="lnk_application_tab">
                            {% if validated_application %}
                            <span class="glyphicon glyphicon-ok-sign" aria-hidden="true" style="color:green;"></span>
                            {%else%}
                                <span class="glyphicon glyphicon-exclamation-sign" aria-hidden="true" style="color:orange;"></span>
                            {%endif%}
                            &nbsp;&nbsp;{%trans 'offer_choice'%}                     {%if application.offer_year %}
                    ({{application.offer_year.acronym}})
                    {%endif%}</a>

                    {%endif%}

                </li>
                <li class="{%if tab_active == 2 %}active{%endif%}" >
                    <a href="{%if tab_diploma%}{%if application.id %}{% url 'diploma_update' application.id%}{%else%}{% url 'diploma_update'%}{%endif%}{%endif%}"
                       id="lnk_diploma_tab"
                       class="{%if tab_diploma%}{%else%}not-active{%endif%}">
                        {% if validated_diploma %}
                            <span class="glyphicon glyphicon-ok-sign" aria-hidden="true" style="color:green;"></span>
                        {%else%}
                            <span class="glyphicon glyphicon-exclamation-sign" aria-hidden="true" style="color:orange;"></span>
                        {%endif%}
                        &nbsp;&nbsp;{%trans 'prerequisites'%}</a>
                </li>
                <li class="{%if tab_active == 3 %}active{%endif%}">

                    <a href="{%if tab_curriculum%}{%if application.id %}{% url 'curriculum_update' application.id%}{%else%}{% url 'curriculum_update' %}{%endif%}{%endif%}"
                       id="lnk_curriculum_tab"
                       class="{%if tab_curriculum%}{%else%}not-active{%endif%}" >
                        {% if validated_curriculum %}
                            <span class="glyphicon glyphicon-ok-sign" aria-hidden="true" style="color:green;"></span>
                        {%else%}
                            <span class="glyphicon glyphicon-exclamation-sign" aria-hidden="true" style="color:orange;"></span>
                        {%endif%}
                        &nbsp;&nbsp;{%trans 'curriculum'%}</a>
                </li>
                <li class="{%if tab_active == 4 %}active{%endif%}">
                        <a href="{%if tab_accounting%}{%if  application.id%}{% url 'accounting_update' application.id%}{%else%}{% url 'accounting_update' %}{%endif%}{%endif%}"
                           id="lnk_accounting_tab"
                           class="{%if tab_accounting%}{%else%}not-active{%endif%}" >
                        {% if validated_accounting %}
                            <span class="glyphicon glyphicon-ok-sign" aria-hidden="true" style="color:green;"></span>
                        {%else%}
                            <span class="glyphicon glyphicon-exclamation-sign" aria-hidden="true" style="color:orange;"></span>
                        {%endif%}
                            &nbsp;&nbsp;{%trans 'accounting'%}</a>
                </li>
                <li class="{%if tab_active == 5 %}active{%endif%}">
                    {%if tab_sociological%}
                    <a href="{%if application.id%}{% url 'sociological_survey' application.id%}{%else%}{% url 'sociological_survey' %}{%endif%}"
                       id="lnk_sociological_tab">
                        {% if validated_sociological %}
                            <span class="glyphicon glyphicon-ok-sign" aria-hidden="true" style="color:green;"></span>
                        {%else%}
                            <span class="glyphicon glyphicon-exclamation-sign" aria-hidden="true" style="color:orange;"></span>
                        {%endif%}
                        &nbsp;&nbsp;{%trans 'sociological_survey'%}</a>
                    {%else%}
                    <a class="not-active"
                       id="lnk_sociological_tab">
                        {% if validated_sociological %}
                            <span class="glyphicon glyphicon-ok-sign" aria-hidden="true" style="color:green;"></span>
                        {%else%}
                            <span class="glyphicon glyphicon-exclamation-sign" aria-hidden="true" style="color:orange;"></span>
                        {%endif%}
                        &nbsp;&nbsp;{%trans 'sociological_survey'%}</a>

                    {%endif%}
                </li>
                <li class="{%if tab_active == 6 %}active{%endif%}">
                        <a href="{%if tab_attachments%}{%if application.id%}{% url 'attachments' application.id %}{%else%}{% url 'attachments' %}{%endif%}{%endif%}"
                           id="lnk_attachments_tab"
                           {%if tab_attachments%}{%else%}class="not-active"{%endif%}>
                            {% if validated_attachments %}
                                <span class="glyphicon glyphicon-ok-sign" aria-hidden="true" style="color:green;"></span>
                            {%else%}
                                <span class="glyphicon glyphicon-exclamation-sign" aria-hidden="true" style="color:orange;"></span>
                            {%endif%}
                            &nbsp;&nbsp;{%trans 'attachments'%}</a>
                </li>
                <li class="{%if tab_active == 7 %}active{%endif%}">
                        <a href="{%if tab_submission%}{%if application.id%}{% url 'submission' application.id %}{%else%}{% url 'submission' %}{%endif%}{%endif%}"
                           id="lnk_submission_tab"
                           {%if tab_submission%}{%else%}class="not-active"{%endif%}>
                            {% if validated_submission %}
                                <span class="glyphicon glyphicon-ok-sign" aria-hidden="true" style="color:green;"></span>
                            {%else%}
                                <span class="glyphicon glyphicon-exclamation-sign" aria-hidden="true" style="color:orange;"></span>
                            {%endif%}
                            &nbsp;&nbsp;{%trans 'submission'%}</a>
                </li>
            </ul>
        </div>
        <div class="col-md-10">
            {%if tab_demande_active >= 0 and tab_demande_active < 3 and application.offer_year%}
                <h4>{{application.offer_year.title}}</h4>
            {%endif%}

            <div class="panel panel-default">
                <div class="panel-body">
                    {% block admission_tabs %}
                    {% endblock %}
                </div>
            </div>
        </div>
    </div>

    <br>
    <input type="hidden" id="hdn_pushed" />

{% endblock %}

{% block script %}
    <script src="{% static 'js/bootstrap-datepicker.min.js' %}"></script>
    <script>
    $(document).ready(function() {
        if($('#hdn_tab_active').val()=='2'){
            $('#form_secondary_education').append( $('#pnl_files>div') );
        }
        $('#pnl_assimilation_criteria').css('visibility', 'hidden').css('display','none');
        if($("#slt_nationality").val()!="-1"){
            $.ajax({
                url: "/admission/country?nationality=" + $("#slt_nationality").val()
            }).then(function(data) {
                if(data.length > 0 ){
                    if (data.european_union) {
                        $('#pnl_assimilation_criteria').css('visibility', 'hidden').css('display','none');
                    }else{
                        $('#pnl_assimilation_criteria').css('visibility', 'visible').css('display','block');
                    }
                }
            });
        }

        $('#txt_admission_exam_date').val('');
        $('#txt_admission_exam_institution').val('');
        $('[id^="rdb_admission_exam_type_"]').prop( "checked", false);
        $('#txt_admission_exam_type_other').val('');
        $('#txt_admission_exam_type_other').prop( "disabled", true);
        $('#chb_admission_exam_type').prop( "checked", false);

        populate_exam_admin();
        if($("#hdn_application_offer_year_id").val()){
            display_dynamic_form($("#hdn_application_offer_year_id").val());
        }
        if($('#hdn_current_application_id').val() != '') {
            $('#txt_offer_year_id').val($('#hdn_application_offer_year_id').val())
            $('#slt_offer_type').val($('#hdn_application_grade').val())
            display_known_offer($('#hdn_application_offer_year_id').val());
        }
        //If information message is on the screen it will disappear after 5s
        $('#message_info').fadeOut(5000);

    });

    function save(form_to_submit){
        var id = 'form#' + form_to_submit;
        $(id).submit();
    }

    $("#lnk_profil_next_step").click(function(e) {
        $('#txt_message_error_profile').css('visibility', 'hidden').css('display','none');
        if (! valid()){
            return false;
        }
        $('#hdn_tab_applications_status').val('True');
        save('form_profile');
        return true;
    });

    $("#lnk_profil_next_step_up").click(function(e) {
        if (! valid()){
            return false;
        }
        $('#hdn_tab_applications_status').val('True');
        save('form_profile');
        return true;
    });

    $("#lnk_application_tab").click(function(e) {
        if(! valid()){
            return false;
        }
        if ($('#hdn_application_id').val()){
            $('#slt_offer_type option').each(function(){
                if($(this).attr('value')==$('#hdn_application_grade').val()){
                    $(this).prop('selected', true);
                }
            });
            $('#slt_domain option').each(function(){
                if($(this).attr('value')==$('#hdn_application_domain_id').val()){
                    $(this).prop('selected', true);
                }
            });
        }
    });

    $("#btn_modify_picture").click(function(event) {
        update_description('ID_PICTURE', $(event.target));
        display_existing_files('ID_PICTURE');
    });

    $("#btn_modify_id_document").click(function(event) {
        update_description('ID_CARD',$(event.target));
        display_existing_files('ID_CARD');
    });

    $("#txt_birth_date").blur(function() {
        var value = $("#txt_birth_date").val();
        $("#msg_error_birth_date").find("label").remove();
        if (isDate(value)){
            $("#msg_error_birth_date").find("label").remove();
        }else{
            $("#msg_error_birth_date").append("<label>Invalid</label>");
        }
    });

    function isDate(txtDate){
        var currVal = txtDate;
        if(currVal == '')
            return false;

        var rxDatePattern = /^(\d{1,2})(\/|-)(\d{1,2})(\/|-)(\d{4})$/; //Declare Regex
        var dtArray = currVal.match(rxDatePattern); // is format OK?

        if (dtArray == null)
            return false;

        //Checks for mm/dd/yyyy format.
        dtDay = dtArray[1];
        dtMonth= dtArray[3];
        dtYear = dtArray[5];

        if (dtMonth < 1 || dtMonth > 12) {
            return false;
        } else if (dtDay < 1 || dtDay> 31) {
            return false;
        } else if ((dtMonth==4 || dtMonth==6 || dtMonth==9 || dtMonth==11) && dtDay ==31) {
            return false;
        } else if (dtMonth == 2) {
            var isleap = (dtYear % 4 == 0 && (dtYear % 100 != 0 || dtYear % 400 == 0));
            if (dtDay> 29 || (dtDay ==29 && !isleap)) {
                return false;
            }
        }
        if (dtYear< 1900){
            return false;
        }
        return true;
    }

    function valid(){
        if($("#hdn_tab_active").val()=="0"){
            if (! valid_profile()){
                if ($('#txt_message_error_profile_up').html() == ''){
                    $('#txt_message_error_profile_up').css('visibility', 'visible').css('display','block');
                    $('#txt_message_error_profile_up').text(gettext('invalid_data'));
                }
                return false;
            }
        }
        if($("#hdn_tab_active").val()=="1"){
            if (! valid_offer()){
                return false;
            }
        }
        return true;
    }

    function valid_profile(){
        $('#txt_message_error_profile_up').css('visibility', 'hidden').css('display','none');
        $('#txt_message_error_profile_up').html('');
        // clear error messages
        $('#spn_number_children').html('');
        $('#spn_last_academic_year').html('');
        $('#spn_contact_adr_street').html('');
        $('#spn_contact_adr_number').html('');
        $('#spn_contact_adr_postal_code').html('');
        $('#spn_contact_adr_city').html('');
        $('#spn_contact_adr_country').html('');
        $('#spn_legal_adr_street').html('');
        $('#spn_legal_adr_number').html('');
        $('#spn_legal_adr_postal_code').html('');
        $('#spn_legal_adr_city').html('');
        $('#spn_legal_adr_country').html('');
        $('#spn_additional_email').html('');
        $('#spn_registration_id').html('');
        $('#spn_last_academic_year').html('');

        if($('#txt_number_children').val() != ''){
            if(! $.isNumeric( $('#txt_number_children').val())){
                $('#spn_number_children').text(gettext('number_invalid'));
                return false;
            }else{
                var nb_children = parseInt($('#txt_number_children').val());
                if(nb_children < 0 || nb_children >20){
                    $('#spn_number_children').text(gettext('number_invalid'));
                    return false;
                }
            }
        }
        if( $('#rd_previous_enrollment_true').prop('checked')){
            txt_registration_id
            if($('#txt_registration_id').val() == ''){
                $('#spn_registration_id').text(gettext('previous_enrollment_required_nb'));
                return false;
            }
            if($('#txt_last_academic_year').val() == ''){
                $('#spn_last_academic_year').text(gettext('previous_enrollment_required_year'));
                return false;
            }
        }
        if($('#txt_last_academic_year').val() != ''){
            if(! $.isNumeric( $('#txt_last_academic_year').val())){
                $('#spn_last_academic_year').text(gettext('number_invalid'));
                return false;
            }else{
                var year = parseInt($('#txt_last_academic_year').val());
                if(year < 1900 || year >3000){
                    $('#spn_last_academic_year').text(gettext('number_invalid'));
                    return false;
                }
            }
        }
        if (($("#slt_nationality").prop('selectedIndex') < 0
            || $("#slt_legal_adr_country").prop('selectedIndex') < 0) || ($("#slt_nationality").val()=='-1' || $("#slt_legal_adr_country").val()=='-1')){
            $("#txt_message_error_profile_up").text(gettext('msg_next_profil'));
            $('#txt_message_error_profile_up').css('visibility', 'visible').css('display','block');
            return false;
        }

        var legal_valid = true;
        if($('#txt_legal_adr_street').val() == '' ){
            $('#spn_legal_adr_street').text(gettext('legal_street'));
            legal_valid = false;
        }
        if($('#txt_legal_adr_number').val() == '' ){
            $('#spn_legal_adr_number').text(gettext('legal_number'));
            legal_valid = false;
        }
        if($('#txt_legal_adr_postal_code').val() == '' ){
            $('#spn_legal_adr_postal_code').text(gettext('legal_postal_code'));
            legal_valid = false;
        }
        if($('#txt_legal_adr_city').val() == '' ){
            $('#spn_legal_adr_city').text(gettext('legal_postal_code'));
            legal_valid = false;
        }
        if($('#slt_legal_adr_country').prop('selectedIndex') <= 0 ){
            $('#spn_legal_adr_country').text(gettext('legal_country'));
            legal_valid = false;
        }
        if(legal_valid == false){
            return legal_valid;
        }
        if($('#rd_same_contact_legal_addr_false').prop("checked")){
            var contact_valid = true;
            if($('#txt_contact_adr_street').val() == '' ){
                $('#spn_contact_adr_street').text(gettext('contact_street'));
                contact_valid = false;
            }
            if($('#txt_contact_adr_number').val() == '' ){
                $('#spn_contact_adr_number').text(gettext('contact_number'));
                contact_valid = false;
            }
            if($('#txt_contact_adr_postal_code').val() == '' ){
                $('#spn_contact_adr_postal_code').text(gettext('contact_postal_code'));
                contact_valid = false;
            }
            if($('#txt_contact_adr_city').val() == '' ){
                $('#spn_contact_adr_city').text(gettext('contact_postal_code'));
                contact_valid = false;
            }
            if($('#slt_contact_adr_country').prop('selectedIndex') <= 0 ){
                $('#spn_contact_adr_country').text(gettext('contact_country'));
                contact_valid = false;
            }
            if(contact_valid == false){
                return contact_valid;
            }
        }
        // email validation
        var sEmail = $('#txt_additional_email').val();
        if ($.trim(sEmail).length > 0 && validateEmail(sEmail) == false) {
            $('#spn_additional_email').text(gettext('invalid_email'));
            return false;
        }
        return true;
    }

    $("#lnk_diploma_tab").click(function() {
        $('#form_secondary_education').append( $('#pnl_files>div') );
        if (! valid()) {
            return false;
        }
    });

    $("#lnk_curriculum_tab").click(function() {
        if (! valid()){
            return false;
        }
    });

    $("#lnk_accounting_tab").click(function() {
        if (! valid()){
            return false;
        }
    });

    $("#lnk_sociological_tab").click(function() {
        if (! valid()){
            return false;
        }
    });

    $("#lnk_attachments_tab").click(function() {
        if (! valid()){
            return false;
        }
    });

    $("#lnk_submission_tab").click(function() {
        if (! valid()){
            return false;
        }
    });

    $("#lnk_profile_tab").click(function() {
        if($("#hdn_tab_active").val() != "1") {
            if (! valid()) {
                return false;
            }
        }
    });

    function valid_offer() {
        if ($("#txt_offer_year_id").val()==''
            || ($('#rdb_offer_belgiandegree_true').prop("checked") == "false" && $('#rdb_offer_belgiandegree_false').prop("checked") == "false") ){
            $("#txt_message_error_offer_up").text(gettext('msg_next_offer'));
            $('#txt_message_error_offer_up').css('visibility', 'visible').css('display','block');
            $("#txt_message_error_offer_down").text(gettext('msg_next_offer'));
            $('#txt_message_error_offer_down').css('visibility', 'visible').css('display','block');
            return false;
        }
        return true;
    }

    $("#lnk_next_offer_step_up").click(function() {
       return offer_steps();
    });

    $("#lnk_next_offer_step").click(function() {
        return offer_steps();
    });

    $("#lnk_previous_offer_step_up").click(function() {
       $('#form_secondary_education').append( $('#pnl_files>div') );
       return offer_steps();
    });

    $("#lnk_previous_offer_step").click(function() {
        $('#form_secondary_education').append( $('#pnl_files>div') );
        return offer_steps();
    });

    function offer_steps(){
        $('#txt_message_error_offer_up').css('visibility', 'hidden').css('display','none');
        $('#txt_message_error_offer_down').css('visibility', 'hidden').css('display','none');
        if (! valid()){
            return false;
        }
        $('#hdn_tab_applications_status').val('True');
        save('form_questions');
        return true;
    }

    function display_known_offer(offer_year_id){
        ajax_grade_choice($('#hdn_application_grade_type_id').val());
        $('#slt_domain').val($('#hdn_application_domain_id').val());
        ajax_offers($('#hdn_application_grade_type_id').val(),$('#hdn_application_offer_year_id').val());
        display_dynamic_form(offer_year_id);
        ajax_static_questions(offer_year_id,$('#hdn_applied_to_sameprogram').val(),$('#hdn_belgian_degree').val(),$('#hdn_started_samestudies').val());
    }

    //***************************
    //Assimilation criteria
    //***************************
    $( "input[name^='assimilation_criteria_']" ).click(function(event) {
        //One of the criteria has been checked as true or false
        var target = $(event.target);
        var id = target.attr("id");

        if(id.endsWith("_false")){
            var criteria = id.replace('assimilation_criteria_','');
            criteria = criteria.replace('_false','');
            $("#pnl_criteria_"+criteria).css('visibility', 'hidden').css('display','none');
        }

        if(id.endsWith("_true")){
            //Hide all pnl_criteria to let only one visible
            $('[id^="pnl_criteria_"]').each(function(){
                var target_pnl = $(this);
                var id_pnl = target_pnl.attr("id");

                var pos = id_pnl.indexOf('pnl_criteria_')
                var criteria_id = id_pnl.substring(pos+13)

                if ($('input[type=radio][name=assimilation_criteria_'+criteria_id+']:checked').attr('value') == 'true'){
                   if(id != 'assimilation_criteria_'+criteria_id+'_true'){
                        $('#assimilation_criteria_'+criteria_id+'_false').prop( "checked", true);
                   }
                }
                $(this).css('visibility', 'hidden').css('display','none');
            });
            var criteria = id.replace('assimilation_criteria_','');
            criteria = criteria.replace('_true','');
            $("#pnl_criteria_"+criteria).css('visibility', 'visible').css('display','block');
            $("#slt_criteria_5").val("");
        }
    });

    $(document).bind('click', function (e) {
        var target = $(e.target);
        var id = target.attr("id");
        if (target.is('.class_upload_assimilation')) {
            e.preventDefault(); // if you want to cancel the event flow

            if(id.startsWith('btn_load_assimilation_doc_') ){
                //upload for assimilation
                var pos = id.indexOf('_id_')
                var description = id.substring(pos+4)
                update_description(description, target);
                display_existing_files(description)
            }
        }

        if(id=='bt_delete_document_file'){
            e.preventDefault(); // if you want to cancel the event flow
            click_bt_delete_document_file();
        }
    });

    $("#slt_criteria_5").change(function(event) {
        $('[id^="pnl_criteria_bis_"]').each(function(){
            $(this).remove();
        });

        var target = $(event.target);
        var id = target.attr("id");
        var selected_criteria = $("#slt_criteria_5").val();
        var div_cloned =$("#pnl_criteria_"+selected_criteria).clone();
        var id_cloned_div = "pnl_criteria_bis_"+selected_criteria;
        div_cloned.attr("id",id_cloned_div);
        div_cloned.css('visibility', 'visible').css('display','block');
        div_cloned.appendTo("#pnl_other_criteria");
        var span = "<div>"+ gettext('concerned_person')+"</div>";
        $('#'+id_cloned_div+' .panel-heading').append(span);
    });
    //***************************
    //Assimilation criteria - end
    //***************************

    //***************************
    //File upload
    //***************************
    function update_description(description, elt){
        $('#hdn_description').val(description);
        $('#lbl_description_label').text(gettext(description.toLowerCase()));
        $('#txt_file').val('');
        $('#hdn_pushed').val(elt.attr("id"));
    }

    $("#txt_file").on("change", function(){
       var file = this.files[0];
       fileName = file.name;
       $("#hdn_filename").val(fileName);
    });

    $('[id^="bt_load_doc_"]').click(function(event) {
        var target = $(event.target);
        var id = target.attr("id");
        var pos = id.indexOf('bt_load_doc_');
        var description = id.substring(pos+12);
        update_description(description, target);
        display_existing_files(description);
    });

    $("#bt_upload_document").click(function(event) {
        var target = $(event.target);
        var id = target.attr("id");
        var form = target.form;

        var description = $("#hdn_description").val();
        //Clear existing fields
        $('#hdn_file_'+$("#txt_file").val()).remove();
        $('#hdn_file_name_'+description).remove();
        $('#hdn_file_description_'+description).remove();
        var fileSelect = document.getElementById('txt_file');
        var files = fileSelect.files;
        var file = files[0];
        var data = new FormData();
        data.append('description', description);
        data.append('storage_duration', 0);
        data.append('content_type',file.type);
        data.append('filename', $("#txt_file").val());
        data.append('application_id', $("#hdn_current_application_id").val());


        var accepted_types = ['application/csv',
                              'application/doc',
                              'application/pdf',
                              'application/xls',
                              'application/xlsx',
                              'application/xml',
                              'application/zip',
                              'image/jpeg',
                              'image/gif',
                              'image/png',
                              'text/html',
                              'text/plain'];
        if(file){
            if ($.inArray(file.type,accepted_types) >= 0){
                data.append('file', file);
                $.ajax({
                    url: "{% url 'save_uploaded_file' %}",
                    enctype: 'multipart/form-data',
                    type: 'POST',
                    data : data,
                    processData: false,
                    contentType: false,
                    complete: function(xhr, statusText){
                        if(xhr.status=='0'){
                            //problem occured
                            $('#pnl_admission_error').remove();
                            var msg_error = jQuery('<div class="alert alert-danger" id="pnl_admission_error">'+ gettext('error_occured')+'</span>');
                            $('#pnl_admission_errors').append(msg_error);
                            return false;
                        }
                    }

                });
                update_upload_btn_class(file, description);
                return true;
            }else{
                display_existing_files(description);
                $("#txt_file").val('')
                $('#pnl_upload_error').remove();
                var msg_error = jQuery('<div class="alert alert-danger" id="pnl_upload_error">'+ file.name + ' : ' +gettext('invalid_content_type')+ ' </span>');
                $('#pnl_modal_upload').append(msg_error);
                event.preventDefault();
                event.stopImmediatePropagation();
                return false;
            }
        }else{
                display_existing_files(description);
                $("#txt_file").val('')
                $('#pnl_upload_error').remove();
                var msg_error = jQuery('<div class="alert alert-warning" role="alert" id="pnl_upload_error">' +gettext('select_file')+ ' </div>');
                $('#pnl_modal_upload').append(msg_error);
                event.preventDefault();
                event.stopImmediatePropagation();
                return false;
        }


    });

    //***************************
    //File upload - end
    //***************************
    function display_existing_files(description){
        // To clear the div
        $("#pnl_existing_files").html('')
        $("#pnl_existing_files").find("a")
            .remove()
            .end()
        $("#pnl_modal_upload").find("span").remove();
        $.ajax({
            url: "/admission/document?description=" + description
        }).then(function(data) {
            if(data.length > 0 ){
                $('#pnl_existing_files').append("<br>");
                $('#pnl_existing_files').append('<span style="text-decoration:underline;">Existing file :</span>');
                $.each(data, function(key, value) {
                    var url = build_url('upload/download/', value.id);
                    $('#pnl_existing_files').append("<br>");
                    $('#pnl_existing_files').append($("<a></a>").attr("href", url)
                                                                .attr("target","_blank")
                                                                .append(value.file_name));
                    var url = build_url('upload/delete/', value.id);
                    var bt = jQuery('<input  id="hdn_delete_document_file" type="hidden" value="'+value.id+'">');
                    $('#pnl_existing_files').append(bt);
                    $('#pnl_existing_files').append('&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;');
                    bt = jQuery('<button type="submit" id="bt_delete_document_file" class="btn btn-default" data-dismiss="modal"><span class="glyphicon glyphicon-trash"></span></button>');
                    $('#pnl_existing_files').append(bt);

                });
            }
        });
    }

    function build_url(url_begin, value){
        /*Todo try to use django url directly in href - Leila*/
        var loc = location.href;
        var count = 0;
        var pos = loc.indexOf('/admission/');

        pos = pos + 12;
        while ( pos != -1 ) {
           count++;
           pos = loc.indexOf( "/",pos + 1 );
        }
        count=count-1;
        var url = url_begin + value;
        var cpt = 0;
        while (cpt< count){
            url = "../" + url
            cpt=cpt+1;

        }
        return url;
    }

    function click_bt_delete_document_file(){
        var document_file_id = $('#hdn_delete_document_file').val();
        var description = $("#hdn_description").val();
        var data = new FormData();
        data.append('document_file_id', document_file_id);
        $.ajax({
            url: "{% url 'delete_document_file' %}",
            type: 'POST',
            data : data,
            processData: false,
            contentType: false

        });
        update_upload_btn_class('',description);
        return true;
    }

    function update_upload_btn_class(file, description){
        if(file != ''){
            if(description == 'ID_PICTURE'){
                $('#btn_modify_picture').attr('title', gettext('change_document'));
                $('#btn_modify_picture').attr('class', 'btn btn-success ');
                $('#spn_modify_picture').attr('class', 'glyphicon glyphicon-ok-circle');
            }

            if(description == 'ID_CARD'){
                $('#btn_modify_id_document').attr('title', gettext('change_document'));
                $('#btn_modify_id_document').attr('class', 'btn btn-success');
                $('#spn_modify_id_document').attr('class', 'glyphicon glyphicon-ok-circle');
            }

            $('[id$="'+description+'"]').each(function(){
                if($(this).attr("id").startsWith('btn_load_assimilation_doc_')){
                    $(this).attr('title', gettext('change_document'));
                    $(this).attr('class', 'btn btn-success class_upload_assimilation');
                    var spn_id = '#spn_' +$(this).attr("id");
                    $(spn_id).attr('class', 'glyphicon glyphicon-ok-circle');
                }
                if( $(this).attr("id").startsWith('bt_load_doc_')){
                    if($(this).attr("id")=='bt_load_doc_'+description  ){
                        $(this).attr('title', gettext('change_document'));
                        $(this).attr('class', 'btn btn-success');
                        var spn_id = '#spn_' +$(this).attr("id");
                        $(spn_id).attr('class', 'glyphicon glyphicon-ok-circle');
                    }
                }
            });
        } else {
            if(description == 'ID_PICTURE'){
                $('#btn_modify_picture').attr('title', gettext('add_document'));
                $('#btn_modify_picture').attr('class', 'btn');
                $('#spn_modify_picture').attr('class', 'glyphicon glyphicon-upload');
            }

            if(description == 'ID_CARD'){
                $('#btn_modify_id_document').attr('title', gettext('add_document'));
                $('#btn_modify_id_document').attr('class', 'btn');
                $('#spn_modify_id_document').attr('class', 'glyphicon glyphicon-upload');
            }

            $('[id$="'+description+'"]').each(function() {
                if($(this).attr("id").startsWith('btn_load_assimilation_doc_') || $(this).attr("id").startsWith('bt_load_doc_')) {
                    if($(this).attr("id")=='bt_load_doc_'+description){
                        $(this).attr('title', gettext('add_document'));
                        $(this).attr('class', 'btn');
                        var spn_id = '#spn_' +$(this).attr("id");
                        $(spn_id).attr('class', 'glyphicon glyphicon-upload');
                    }
                }
            });
        }
    }
    function validateEmail(sEmail) {
        var filter = /^([\w-\.]+)@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.)|(([\w-]+\.)+))([a-zA-Z]{2,4}|[0-9]{1,3})(\]?)$/;
	    if (filter.test(sEmail)) {
	        return true;
	    }else {
	        return false;
	    }
	}

    $("#bt_submit_profile").click(function(e) {
        $('#txt_message_error_profile').css('visibility', 'hidden').css('display','none');
        if (! valid(e)){
            return false;
        }
        return true;
    });

    $("#rd_previous_enrollment_false").click(function() {
        $('#txt_registration_id').val('');
        $('#txt_last_academic_year').val('');
    });

    </script>
{% endblock %}